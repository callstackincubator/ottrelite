# Ottrelite interoperability package with OTEL

## Status of the project

| Feature         | Status |
| --------------- | ------ |
| OTEL-JS interop | ✅     |
| RN integration  | ✅     |

## OTEL interoperability

Ottrelite provides interoperability with OpenTelemetry (OTEL) through a set of adapter facilities.

### Javascript

Firstly, Ottrelite provides its own `TracerProvider` ([`OttreliteTracerProvider.ts`](https://github.com/callstackincubator/ottrelite/blob/main/packages/interop-otel/src/otel/OttreliteTracerProvider.ts)) that provides adequate configuration for JS (configures the default resource to carry ottrelite's metadata, registers W3C & trace context baggage propagators, by default - `StackContextManager`). Invoking `register` on it, apart from the aforementioned, also calls invokes configuration of the global C++ API provider, described in the section below.

The analogous applies to [`OttreliteMeterProvider`](https://github.com/callstackincubator/ottrelite/blob/main/packages/interop-otel/src/otel/OttreliteMeterProvider.ts). An implementation detail difference is that the meter provider hooks into returned instrument creation methods & their return values dynamically by replacing properties on instances, to call its own logic before the original is executed.

The OTEL API is also hooked into by the [`DevSpanProcessorInterceptor.ts`](https://github.com/callstackincubator/ottrelite/blob/main/packages/interop-otel/src/otel/processor/DevSpanProcessorInterceptor.ts), which can be registered to propagate all OTEL spans live to the [Development API](https://callstackincubator.github.io/ottrelite/docs/core/quick-start.html#development-api-1).

```typescript
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';
import { resourceFromAttributes } from '@opentelemetry/resources';
import { SimpleSpanProcessor } from '@opentelemetry/sdk-trace-base';
import {
  ATTR_SERVICE_NAME,
  ATTR_SERVICE_VERSION,
} from '@opentelemetry/semantic-conventions';
import {
  DevSpanProcessorInterceptor,
  OttreliteMeterProvider,
  OttreliteTracerProvider,
} from '@ottrelite/interop-otel';

// optional step: resource attributes; below: example options, this can be customized as needed
const resource = resourceFromAttributes({
  [ATTR_SERVICE_NAME]: appName,
  [ATTR_SERVICE_VERSION]: getVersion(),
  'device.id': getDeviceId(),
  'os.name': Platform.OS,
  'os.version': getSystemVersion(),
});

const tracerProvider = new OttreliteTracerProvider({
  spanProcessors: [
    new DevSpanProcessorInterceptor(),

    new SimpleSpanProcessor(
      new OTLPTraceExporter({
        url: `http://localhost:4318/v1/`,
      })
    ),
  ],
  resource,
});

// register the React Native tracer provider
tracerProvider.register();

// configure the OpenTelemetry MeterProvider to use Ottrelite's capabilities
const meterProvider = new OttreliteMeterProvider({
  resource,
});

meterProvider.register();
```

##### OTEL Instrumentations

Optionally, configure automatic instrumentation of various JS APIs using OpenTelemetry community instrumentations, as you would normally do with OTEL.

```typescript
import { registerInstrumentations } from '@opentelemetry/instrumentation';
import { FetchInstrumentation } from '@opentelemetry/instrumentation-fetch';
import { XMLHttpRequestInstrumentation } from '@opentelemetry/instrumentation-xml-http-request';

// optional step: register instrumentations; Ottrelite integrates with the OTEL JS API, therefore allowing to
// use the same instrumentations as you would with OpenTelemetry JS
// the below example shows a few common instrumentations, but you can add more as needed, inspired by https://opentelemetry.io/docs/demo/services/react-native-app/
registerInstrumentations({
  instrumentations: [
    new FetchInstrumentation({
      clearTimingResources: false,
      propagateTraceHeaderCorsUrls: /.*/,
    }),
    new XMLHttpRequestInstrumentation({
      ignoreUrls: [/\/fetch-urls\/.*/],
    }),
  ],
});
```

## Demo

The `examples/backend-jaeger` directory contains a Docker Compose file for running the Jaeger backend service. Not that Jaeger does not support metrics. To run it, execute `docker compose up -d`, which will start the Jaeger backend with an OTLP collector, as well as serve Jaeger UI on `http://localhost:16686/` to collect OTEL data from the example app. Then, just run the app on the device you've run Jaeger on (otherwise, you will need to adjust endpoint path to match your server's address) and you should start seeing traces in the Jaeger UI.
